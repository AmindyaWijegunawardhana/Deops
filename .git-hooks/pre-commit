#!/usr/bin/env bash
# Pre-commit hook - Run before commit
# Validates code quality, formatting, and security

set -e

echo "üîç Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
EXIT_CODE=0

# Check for uncommitted changes in staged files
for FILE in $STAGED_FILES; do
    if [[ $FILE == *.js || $FILE == *.jsx ]]; then
        if ! git diff --cached --quiet HEAD -- "$FILE"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Checking $FILE${NC}"
        fi
    fi
done

# 1. Check for console.log statements in production code
echo "üîç Checking for debug statements..."
for FILE in $STAGED_FILES; do
    if [[ $FILE == *.js || $FILE == *.jsx ]] && [[ ! $FILE =~ test|spec ]]; then
        if grep -n "console\.log\|debugger\|alert(" "$FILE" 2>/dev/null | grep -v "^\s*\/\/"; then
            echo -e "${RED}‚ùå Found debug statements in $FILE${NC}"
            EXIT_CODE=1
        fi
    fi
done

# 2. Check for large files
echo "üîç Checking file sizes..."
for FILE in $STAGED_FILES; do
    SIZE=$(stat -f%z "$FILE" 2>/dev/null || stat -c%s "$FILE" 2>/dev/null)
    if [ "$SIZE" -gt 5242880 ]; then
        echo -e "${RED}‚ùå File $FILE is too large ($(($SIZE/1048576))MB > 5MB)${NC}"
        EXIT_CODE=1
    fi
done

# 3. Check for secrets/credentials
echo "üîç Checking for exposed secrets..."
PATTERNS=(
    'password.*=.*["\x27]'
    'api[_-]?key.*=.*["\x27]'
    'secret.*=.*["\x27]'
    'AWS_SECRET'
    'PRIVATE.*KEY'
    'DATABASE.*PASS'
)

for FILE in $STAGED_FILES; do
    for PATTERN in "${PATTERNS[@]}"; do
        if grep -iE "$PATTERN" "$FILE" 2>/dev/null | grep -v "^#" | grep -v ".example" > /dev/null; then
            echo -e "${RED}‚ùå Possible secret exposed in $FILE${NC}"
            EXIT_CODE=1
        fi
    done
done

# 4. Check for merge conflicts
echo "üîç Checking for merge conflicts..."
for FILE in $STAGED_FILES; do
    if grep -q "<<<<<<< HEAD\|======= \|>>>>>>>" "$FILE"; then
        echo -e "${RED}‚ùå Merge conflict markers found in $FILE${NC}"
        EXIT_CODE=1
    fi
done

# 5. Check JSON files for validity
echo "üîç Validating JSON files..."
for FILE in $STAGED_FILES; do
    if [[ $FILE == *.json ]]; then
        if ! jq empty "$FILE" 2>/dev/null; then
            echo -e "${RED}‚ùå Invalid JSON in $FILE${NC}"
            EXIT_CODE=1
        fi
    fi
done

# 6. Check YAML files for validity
echo "üîç Validating YAML files..."
for FILE in $STAGED_FILES; do
    if [[ $FILE == *.yml || $FILE == *.yaml ]]; then
        if command -v yamllint &> /dev/null; then
            if ! yamllint -c relaxed "$FILE" 2>/dev/null; then
                echo -e "${RED}‚ùå Invalid YAML in $FILE${NC}"
                EXIT_CODE=1
            fi
        fi
    fi
done

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
else
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo "Fix the issues above and try again."
fi

exit $EXIT_CODE
